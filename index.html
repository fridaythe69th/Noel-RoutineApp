<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Disable zooming -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Today's Routine — Minimal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      /* light */
      --bg: #f6f7fb;
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --accent: #4f46e5;
      --accent-2: #7c3aed;
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 6px 18px rgba(16,24,40,0.06);
      --radius: 12px;
      --gap: 12px;
    }
    [data-theme="dark"] {
      --bg: #071025;
      --panel: #071025;
      --muted: #94a3b8;
      --text: #e6eef8;
      --accent: #7c3aed;
      --accent-2: #4f46e5;
      --glass: rgba(255,255,255,0.04);
      --shadow: 0 6px 18px rgba(2,6,23,0.6);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg),transparent);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:12px;
      -webkit-tap-highlight-color: transparent;
    }

    /* App layout */
    .app {
      max-width:980px;
      margin: 8px auto;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 16px;
      align-items:start;
    }

    /* Main panel */
    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    /* Header */
    header.app-header {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .hamburger-btn {
      display:inline-grid;
      place-items:center;
      width:42px;
      height:42px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.04);
      background: transparent;
      cursor:pointer;
      font-size:20px;
      color:var(--text);
    }
    h1 {
      font-size:16px;
      margin:0;
    }
    .muted-sm {
      color:var(--muted);
      font-size:13px;
      margin-top:4px;
    }

    .controls { display:flex; gap:8px; align-items:center; }
    .primary {
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
    }

    /* Now / Upcoming / Today's sections */
    .now-card {
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:18px;
      border-radius:12px;
      background: linear-gradient(90deg, rgba(79,70,229,0.06), rgba(124,58,237,0.04));
      margin-bottom:10px;
    }
    .now-title{ font-size:12px; color:var(--muted) }
    .now-task{ font-size:18px; font-weight:700 }
    .now-time{ font-size:13px; color:var(--muted) }

    /* Upcoming card (simple list) */
    .upcoming-card {
      margin-bottom:12px;
      border-radius:12px;
      overflow:hidden;
    }
    .upcoming-card .panel {
      padding:12px;
    }
    .up-title {
      font-weight:700;
      margin:0 0 8px 0;
    }
    .up-list { display:flex; flex-direction:column; gap:8px; }
    .up-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      border-radius:8px;
      background: linear-gradient(180deg, rgba(0,0,0,0.01), transparent);
    }
    .up-item .muted { font-size:13px; color:var(--muted) }

    /* Today's task container - sectioned style */
    .today-panel {
      border-radius:12px;
      padding:8px;
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .today-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 6px;
    }
    .divider { height:1px; background:rgba(0,0,0,0.04); margin:6px 0; border-radius:4px }

    .list-wrap {
      max-height: calc(60vh);
      overflow:auto;
      padding:8px;
    }

    /* Task row - minimal/sectioned */
    .task-item {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px;
      border-radius:10px;
      background: transparent;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      transition: transform .25s ease, opacity .25s ease;
    }
    .task-item:last-child { border-bottom: none; }

    .task-left {
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .time-pill {
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(79,70,229,0.12);
      color: var(--accent-2);
      font-weight:600;
      white-space:nowrap;
    }
    .task-name { font-weight:600; font-size:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* menu button */
    .task-actions { display:flex; align-items:center; gap:6px; }
    .menu-btn {
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
      padding:6px;
      border-radius:8px;
      color:var(--muted);
    }
    .menu-btn:active, .menu-btn:hover { background: rgba(0,0,0,0.03); color:var(--text) }

    /* dropdown */
    .task-menu {
      position: absolute;
      background: var(--panel);
      border-radius:10px;
      box-shadow: var(--shadow);
      overflow:hidden;
      z-index:999;
      min-width:120px;
    }
    .task-menu-item {
      padding:10px 12px;
      cursor:pointer;
      font-size:14px;
      color:var(--text);
    }
    .task-menu-item:hover { background: rgba(0,0,0,0.04); }

    /* Animations for adding/removing */
    .fade-in { animation: fadeIn .28s ease both; }
    .fade-out { animation: fadeOut .24s ease both; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px) } to { opacity:1; transform:none } }
    @keyframes fadeOut { from { opacity:1; transform:none } to { opacity:0; transform: translateY(-6px) } }

    /* Drawer */
    .drawer {
      position: fixed;
      top:0;
      left:-300px;
      width:300px;
      height:100%;
      background: var(--panel);
      box-shadow: 2px 0 20px rgba(0,0,0,0.12);
      z-index:150;
      transition: left .28s ease;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .drawer.open { left:0 }
    .drawer-header { display:flex; justify-content:space-between; align-items:center; }
    .close-btn { background:none; border:none; font-size:22px; cursor:pointer; }
    .drawer-overlay {
      position: fixed;
      inset:0;
      background: rgba(0,0,0,0.4);
      opacity:0;
      visibility:hidden;
      transition: opacity .2s ease;
      z-index:140;
    }
    .drawer-overlay.active { opacity:1; visibility:visible }

    label { display:block; font-size:13px; margin-bottom:6px; color:var(--muted) }
    select { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--text) }

    /* Sidebar (right column) */
    aside.sidebar {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .mini { font-size:13px }

    /* Responsive */
    @media (max-width:880px){
      .app { grid-template-columns: 1fr; padding:0 8px; }
      aside.sidebar { order:2 }
      .list-wrap { max-height: calc(50vh) }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div>
      <div class="panel">
        <header class="app-header">
          <div class="brand">
            <button id="menuButton" class="hamburger-btn" aria-label="Open settings">
              <!-- simple hamburger -->
              <svg width="18" height="14" viewBox="0 0 18 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1h16M1 7h16M1 13h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            </button>
            <div>
              <h1>Today's Routine</h1>
              <div id="currentDate" class="muted-sm">Loading date...</div>
            </div>
          </div>

          <div class="controls">
            <button id="add-task" class="primary">+ Add Task</button>
          </div>
        </header>

        <!-- Now -->
        <div class="now-card" id="nowCard">
          <div class="now-title">Happening now</div>
          <div class="now-task" id="nowTask">No task — relax or add one</div>
          <div class="now-time muted-sm" id="nowTime">--</div>
        </div>

        <!-- Upcoming (moved above today's list) -->
        <div class="upcoming-card">
          <div class="panel" style="padding:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div class="up-title">Upcoming</div>
              <div class="muted-sm">Next few</div>
            </div>
            <div class="up-list" id="upcomingList">
              <!-- upcoming items -->
            </div>
          </div>
        </div>

        <!-- Today's tasks (sectioned style) -->
        <div class="today-panel" aria-labelledby="todayTitle">
          <div class="today-header">
            <div style="font-weight:700">Today's tasks</div>
            <div class="muted-sm">Start: <span id="startOfDay">--</span> • End: <span id="endOfDay">--</span></div>
          </div>
          <div class="divider"></div>
          <div class="list-wrap">
            <div class="task-list" id="taskList">
              <!-- tasks injected by JS -->
            </div>
          </div>
        </div>

      </div>
    </div>

    <aside class="sidebar">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Routines</div>
          <button class="btn" id="newRoutine">New</button>
        </div>
        <div class="routines">
          <select id="routineSelect"></select>
        </div>
        <div class="muted-sm" style="margin-top:8px">Choose a routine to edit its tasks. Routines are saved locally.</div>
      </div>

      <div class="panel">
        <div style="font-weight:700;margin-bottom:8px">Help & Tips</div>
        <div class="muted-sm">Add tasks with clear time ranges. Tap the ••• on a task to edit or delete it.</div>
      </div>
    </aside>
  </div>

  <!-- Task modal template -->
  <template id="taskModalTpl">
    <div class="modal-backdrop">
      <div class="modal">
        <h3 id="modalTitle">Add Task</h3>
        <div style="margin-top:12px">
          <div class="form-row" style="margin-bottom:10px">
            <input type="text" id="taskName" placeholder="Task name (e.g., Office work)" style="flex:1;width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
          </div>

          <div style="display:flex;gap:10px;align-items:center">
            <div style="flex:1">
              <div class="muted-sm" style="margin-bottom:6px;font-weight:600">Start time</div>
              <div class="time-control">
                <button class="time-button" id="startTimeBtn" type="button">Set start</button>
                <input class="hidden-time-input" id="taskStart" type="time" />
              </div>
            </div>

            <div style="flex:1">
              <div class="muted-sm" style="margin-bottom:6px;font-weight:600">End time</div>
              <div class="time-control">
                <button class="time-button" id="endTimeBtn" type="button">Set end</button>
                <input class="hidden-time-input" id="taskEnd" type="time" />
              </div>
            </div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
            <button class="btn" id="modalCancel">Cancel</button>
            <button class="primary" id="modalSave">Save</button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Routine modal -->
  <template id="routineModalTpl">
    <div class="modal-backdrop">
      <div class="modal">
        <h3>Create Routine</h3>
        <div style="margin-top:12px">
          <input type="text" id="routineName" placeholder="Routine name (e.g., Weekends)" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn" id="routineCancel">Cancel</button>
            <button class="btn" id="routineSave">Create</button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Drawer & overlay -->
  <div id="settingsDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <h2>Settings</h2>
      <button id="closeDrawer" class="close-btn" aria-label="Close settings">&times;</button>
    </div>

    <div class="drawer-content">
      <div>
        <label for="timeFormatSelect">Time format</label>
        <select id="timeFormatSelect">
          <option value="12">12-hour (AM/PM)</option>
          <option value="24">24-hour</option>
        </select>
      </div>

      <div>
        <label for="themeSelect">Theme</label>
        <select id="themeSelect">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>
  </div>
  <div id="drawerOverlay" class="drawer-overlay"></div>

  <script>
    // Keys
    const KEY = 'adhd_routines_v1';
    const KEY_SETTINGS = 'adhd_routines_settings_v1';

    // utils
    const el = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const genId = () => 'id_'+Math.random().toString(36).slice(2,9);

    // Default state
    const defaultData = {
      routines:[
        {id: genId(), name: 'Weekdays', tasks:[
          {id: genId(), name:'Wake up',start:'07:00',end:'07:30'},
          {id: genId(), name:'Morning routine',start:'07:30',end:'08:15'},
          {id: genId(), name:'Commute / Prep',start:'08:15',end:'09:30'},
          {id: genId(), name:'Office work',start:'10:00',end:'13:00'},
          {id: genId(), name:'Lunch',start:'13:00',end:'14:00'},
          {id: genId(), name:'Afternoon work',start:'14:00',end:'18:00'},
          {id: genId(), name:'Evening unwind',start:'20:00',end:'22:00'},
        ]}
      ]
    };
    const defaultSettings = { timeFormat:'12', theme:'light', selectedRoutineId:null };

    function loadState(){ try{ const s = localStorage.getItem(KEY); return s?JSON.parse(s):null }catch(e){return null} }
    function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)) }
    function loadSettings(){ try{ const s = localStorage.getItem(KEY_SETTINGS); return s?JSON.parse(s):null }catch(e){return null} }
    function saveSettings(){ localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)) }

    let state = loadState();
    let settings = loadSettings();
    if(!state){ state = defaultData; saveState(); }
    if(!settings){ settings = defaultSettings; saveSettings(); }
    if(!settings.selectedRoutineId){ settings.selectedRoutineId = state.routines[0].id; saveSettings(); }

    // Elements
    const routineSelect = el('#routineSelect');
    const taskList = el('#taskList');
    const upcomingList = el('#upcomingList');
    const nowTask = el('#nowTask');
    const nowTime = el('#nowTime');
    const startOfDayEl = el('#startOfDay');
    const endOfDayEl = el('#endOfDay');
    const currentDateEl = el('#currentDate');

    // Drawer elements
    const menuButton = el('#menuButton');
    const settingsDrawer = el('#settingsDrawer');
    const drawerOverlay = el('#drawerOverlay');
    const closeDrawer = el('#closeDrawer');
    const themeSelect = el('#themeSelect');
    const timeFormatSelect = el('#timeFormatSelect');

    // Init UI values
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light') }
    applyTheme(settings.theme);
    if(themeSelect) themeSelect.value = settings.theme;
    if(timeFormatSelect) timeFormatSelect.value = settings.timeFormat;

    // Populate routines and render
    function renderRoutineOptions(){
      routineSelect.innerHTML = '';
      state.routines.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id; opt.textContent = r.name;
        if(settings.selectedRoutineId===r.id) opt.selected = true;
        routineSelect.appendChild(opt);
      });
    }

    function currentRoutine(){ return state.routines.find(r=>r.id===settings.selectedRoutineId) || state.routines[0]; }

    // Render all
    renderRoutineOptions();
    renderAll();

    // Events: drawer
    menuButton.addEventListener('click', () => {
      settingsDrawer.classList.add('open');
      drawerOverlay.classList.add('active');
      settingsDrawer.setAttribute('aria-hidden','false');
    });
    closeDrawer.addEventListener('click', closeSettingsDrawer);
    drawerOverlay.addEventListener('click', closeSettingsDrawer);
    function closeSettingsDrawer(){
      settingsDrawer.classList.remove('open');
      drawerOverlay.classList.remove('active');
      settingsDrawer.setAttribute('aria-hidden','true');
    }

    // Settings listeners
    timeFormatSelect.addEventListener('change', (e)=>{
      settings.timeFormat = e.target.value;
      saveSettings();
      renderAll();
    });
    themeSelect.addEventListener('change', (e)=>{
      settings.theme = e.target.value;
      saveSettings();
      applyTheme(settings.theme);
    });

    // Routine select listener
    routineSelect.addEventListener('change', (e)=>{
      settings.selectedRoutineId = e.target.value;
      saveSettings();
      renderAll();
    });

    // Add task button
    el('#add-task').addEventListener('click', openAddTask);
    el('#newRoutine').addEventListener('click', openNewRoutine);

    // Update every 30s for "now" accuracy
    setInterval(updateNowView, 30000);

    // Date display
    function setCurrentDate(){
      const today = new Date();
      const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
      currentDateEl.textContent = today.toLocaleDateString(undefined, opts);
    }
    setCurrentDate();

    // Time helpers
    function getNowMinutes(){ const d=new Date(); return d.getHours()*60 + d.getMinutes(); }
    function timeToMinutes(t){ if(!t) return 0; const [hh,mm]=t.split(':').map(Number); return hh*60 + mm; }
    function formatTime(t){
      if(!t) return '--';
      const [hh,mm] = t.split(':').map(Number);
      if(settings.timeFormat === '24') return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
      const am = hh < 12; const h12 = ((hh + 11) % 12) + 1;
      return `${h12}:${String(mm).padStart(2,'0')} ${am? 'AM' : 'PM'}`;
    }

    // Render functions
    function renderAll(){ renderTaskList(); updateNowView(); renderUpcoming(); renderRoutineOptions(); }

    function renderUpcoming(){
      const routine = currentRoutine();
      upcomingList.innerHTML = '';
      if(!routine) return;
      const nowM = getNowMinutes();
      const upcoming = routine.tasks.filter(t => timeToMinutes(t.start) >= nowM).slice(0,6);
      if(upcoming.length===0){
        const p = document.createElement('div'); p.className='muted-sm'; p.textContent = 'No upcoming tasks'; upcomingList.appendChild(p); return;
      }
      upcoming.forEach(t => {
        const row = document.createElement('div'); row.className='up-item';
        const left = document.createElement('div'); left.textContent = t.name;
        const right = document.createElement('div'); right.className='muted'; right.textContent = formatTime(t.start);
        row.appendChild(left); row.appendChild(right); upcomingList.appendChild(row);
      });
    }

    function renderTaskList(){
      const routine = currentRoutine();
      if(!routine) return;

      // sort
      routine.tasks.sort((a,b)=> timeToMinutes(a.start) - timeToMinutes(b.start));

      // start/end
      if(routine.tasks.length){
        startOfDayEl.textContent = formatTime(routine.tasks[0].start);
        endOfDayEl.textContent = formatTime(routine.tasks[routine.tasks.length-1].end);
      } else { startOfDayEl.textContent='--'; endOfDayEl.textContent='--'; }

      // snapshot for animation
      const oldNodes = Array.from(taskList.children);
      const oldRects = oldNodes.map(n=>n.getBoundingClientRect());

      // clear
      taskList.innerHTML='';

      routine.tasks.forEach(task => {
        const div = document.createElement('div'); div.className='task-item fade-in'; div.dataset.id = task.id;
        const left = document.createElement('div'); left.className='task-left';
        const timePill = document.createElement('div'); timePill.className='time-pill'; timePill.textContent = `${formatTime(task.start)} → ${formatTime(task.end)}`;
        const name = document.createElement('div'); name.className='task-name'; name.textContent = task.name;
        left.appendChild(timePill); left.appendChild(name);

        const actions = document.createElement('div'); actions.className='task-actions';
        const menuBtn = document.createElement('button'); menuBtn.className='menu-btn'; menuBtn.innerHTML = '&#8942;';
        menuBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleTaskMenu(task.id, menuBtn); });
        actions.appendChild(menuBtn);

        div.appendChild(left); div.appendChild(actions);
        taskList.appendChild(div);
      });

      // simple animated reposition (best-effort)
      const newNodes = Array.from(taskList.children);
      newNodes.forEach(node=>{
        const old = oldNodes.find(n=>n.dataset.id === node.dataset.id);
        if(old){
          const oldRect = oldRects[oldNodes.indexOf(old)];
          const newRect = node.getBoundingClientRect();
          const dy = oldRect.top - newRect.top;
          if(Math.abs(dy) > 1){
            node.style.transform = `translateY(${dy}px)`;
            requestAnimationFrame(()=>{ node.style.transition='transform .35s cubic-bezier(.2,.9,.2,1)'; node.style.transform=''; });
          }
        }
      });

      renderUpcoming();
    }

    function updateNowView(){
      const routine = currentRoutine();
      const nowM = getNowMinutes();
      let current = null; let next = null;
      if(routine){
        for(const t of routine.tasks){
          const s = timeToMinutes(t.start), e = timeToMinutes(t.end);
          if(nowM >= s && nowM < e){ current = t; break; }
          if(s > nowM){ next = t; break; }
        }
      }
      if(current){
        nowTask.textContent = current.name;
        nowTime.textContent = `${formatTime(current.start)} → ${formatTime(current.end)}`;
      } else if(next){
        nowTask.textContent = 'No current task';
        nowTime.textContent = `Next: ${next.name} • ${formatTime(next.start)}`;
      } else {
        nowTask.textContent = 'No current task';
        nowTime.textContent = 'You are between routines — consider adding a task';
      }
      // keep list synced
      renderTaskList();
    }

    // Add / Edit / Delete logic
    function openAddTask(){ openTaskModal(); }
    function openEditTask(taskId){
      const routine = currentRoutine();
      const t = routine.tasks.find(x=>x.id===taskId);
      openTaskModal(t);
    }

    function openTaskModal(task=null){
      const tpl = el('#taskModalTpl'); const frag = tpl.content.cloneNode(true);
      const backdrop = frag.querySelector('.modal-backdrop');
      const title = frag.querySelector('#modalTitle');
      const name = frag.querySelector('#taskName');
      const startInput = frag.querySelector('#taskStart');
      const endInput = frag.querySelector('#taskEnd');
      const startBtn = frag.querySelector('#startTimeBtn');
      const endBtn = frag.querySelector('#endTimeBtn');
      const cancel = frag.querySelector('#modalCancel');
      const save = frag.querySelector('#modalSave');

      if(task){ title.textContent='Edit Task'; name.value = task.name; startInput.value = task.start; endInput.value = task.end; startBtn.textContent = formatTime(task.start); endBtn.textContent = formatTime(task.end); }
      else { title.textContent='Add Task'; startBtn.textContent='Set start'; endBtn.textContent='Set end'; }

      startBtn.addEventListener('click', ()=> startInput.focus());
      endBtn.addEventListener('click', ()=> endInput.focus());
      startInput.addEventListener('input', ()=>{ if(startInput.value) startBtn.textContent = formatTime(startInput.value); });
      endInput.addEventListener('input', ()=>{ if(endInput.value) endBtn.textContent = formatTime(endInput.value); });

      cancel.addEventListener('click', ()=>{ backdrop.remove(); });
      backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) backdrop.remove(); });

      save.addEventListener('click', ()=>{
        const nm = name.value.trim(); const st = startInput.value; const ed = endInput.value;
        if(!nm || !st || !ed){ alert('Please provide a name, start and end time'); return; }
        if(timeToMinutes(ed) <= timeToMinutes(st)){ alert('End time must be after start time'); return; }
        const routine = currentRoutine();
        if(task){
          const tObj = routine.tasks.find(x=>x.id===task.id);
          tObj.name = nm; tObj.start = st; tObj.end = ed;
        } else {
          routine.tasks.push({id: genId(), name:nm, start:st, end:ed});
        }
        saveState();
        backdrop.remove();
        renderTaskList();
        updateNowView();
      });

      document.body.appendChild(frag);
    }

    function deleteTask(id){
      if(!confirm('Delete this task?')) return;
      const routine = currentRoutine();
      // animate removal
      const node = taskList.querySelector(`[data-id="${id}"]`);
      if(node){
        node.classList.add('fade-out');
        node.addEventListener('animationend', ()=> {
          routine.tasks = routine.tasks.filter(t=>t.id!==id);
          saveState();
          renderAll();
        }, { once:true });
      } else {
        routine.tasks = routine.tasks.filter(t=>t.id!==id);
        saveState();
        renderAll();
      }
    }

    // routines
    function openNewRoutine(){
      const tpl = el('#routineModalTpl'); const frag = tpl.content.cloneNode(true);
      const backdrop = frag.querySelector('.modal-backdrop');
      const input = frag.querySelector('#routineName');
      const cancel = frag.querySelector('#routineCancel');
      const saveBtn = frag.querySelector('#routineSave');

      cancel.addEventListener('click', ()=>backdrop.remove());
      backdrop.addEventListener('click',(e)=>{ if(e.target===backdrop) backdrop.remove(); });

      saveBtn.addEventListener('click', ()=>{
        const name = input.value.trim(); if(!name) return alert('Please name the routine');
        const r = {id: genId(), name, tasks: []};
        state.routines.push(r); saveState();
        settings.selectedRoutineId = r.id; saveSettings();
        renderRoutineOptions(); renderAll(); backdrop.remove();
      });
      document.body.appendChild(frag);
    }

    // Toggle task menu
    function toggleTaskMenu(taskId, button){
      // close existing
      qsa('.task-menu').forEach(m => m.remove());

      const menu = document.createElement('div');
      menu.className = 'task-menu';
      menu.innerHTML = `<div class="task-menu-item" data-action="edit">Edit</div><div class="task-menu-item" data-action="delete">Delete</div>`;
      document.body.appendChild(menu);

      // position under button, keep on-screen
      const rect = button.getBoundingClientRect();
      const left = Math.max(8, rect.left + window.scrollX - 110);
      const top = rect.bottom + window.scrollY + 8;
      menu.style.left = `${left}px`;
      menu.style.top = `${top}px`;

      menu.querySelector('[data-action="edit"]').addEventListener('click', ()=>{
        openEditTask(taskId); menu.remove();
      });
      menu.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
        deleteTask(taskId); menu.remove();
      });

      // close on outside click
      setTimeout(()=>{ // delay to avoid immediate close on same click
        document.addEventListener('click', ()=> menu.remove(), { once:true });
      }, 10);
    }

    // initial save to ensure keys exist
    saveState(); saveSettings();

    // Register service worker (if it exists)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(()=> console.log('SW registered'))
        .catch(()=> console.log('SW failed'));
    }

    // Kick initial render
    renderAll();
  </script>
</body>
</html>
