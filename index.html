<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- lock scaling/disable zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Today's Routine â€” Beta</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">

  <style>
    /* ===== Reset & layout safety ===== */
    :root{
      /* Pastel light palette */
      --bg: #f7fafc;
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --accent: #7c8de6;    /* pastel indigo */
      --accent-2: #a28be6;  /* pastel purple */
      --success: #48c78e;
      --danger: #fb7185;
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 8px 22px rgba(16,24,40,0.06);
      --radius: 14px;
    }
    [data-theme="dark"] {
      --bg: #071025;
      --panel: #071025;
      --muted: #94a3b8;
      --text: #e6eef8;
      --accent: #5f6df3;
      --accent-2: #8b5cf6;
      --glass: rgba(255,255,255,0.03);
      --shadow: 0 10px 30px rgba(2,6,23,0.6);
    }

    *{box-sizing:border-box}
    html,body{height:100%; overflow-x: hidden;} /* <- fix horizontal overflow on html + body */
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg),transparent);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:12px 0;
      -webkit-tap-highlight-color: transparent;
    }

    /* center container */
    .app {
  width: 100%;
  max-width: 980px;
  margin: 10px auto;
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 16px;
  align-items: start;
  box-sizing: border-box;
  padding: 0 12px; /* inner padding that won't push outside viewport */
}

    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      max-width: 100%;
    }

    /* Header */
    header.app-header {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .hamburger-btn {
      display:inline-grid; place-items:center;
      width:44px; height:44px; border-radius:10px;
      border:1px solid rgba(0,0,0,0.04); background:transparent;
      cursor:pointer; font-size:20px; color:var(--text);
    }
    h1{ font-size:16px; margin:0; }
    .muted-sm{ color:var(--muted); font-size:13px; margin-top:4px; }

    .controls { display:flex; gap:8px; align-items:center; }
    .primary {
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
    }

    /* Now card */
    .now-card {
      padding:16px; border-radius:12px;
      background: linear-gradient(90deg, rgba(124,139,230,0.06), rgba(162,139,230,0.04));
      margin-bottom:12px;
    }
    .now-title{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .now-task{ font-size:18px; font-weight:700; }
    .now-time{ font-size:13px; color:var(--muted); margin-top:6px; }

    /* Upcoming */
    .upcoming-card { margin-bottom:12px; }
    .up-panel { padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(0,0,0,0.01), transparent); box-shadow:none; }
    .up-title{ font-weight:700; }
    .up-list { display:flex; flex-direction:column; gap:8px; margin-top:6px; }
    .up-item {
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 10px; border-radius:8px;
      background: rgba(0,0,0,0.02);
    }
    .up-item .muted { color:var(--muted); font-size:13px; }

    /* Today's tasks (sectioned) */
    .today-panel {
      border-radius:12px; padding:8px; background: var(--panel); box-shadow: var(--shadow);
    }
    .today-header { display:flex; justify-content:space-between; align-items:center; padding:10px 6px; }
    .divider { height:1px; background: rgba(0,0,0,0.04); margin:6px 0; border-radius:4px; }

    .list-wrap { max-height: calc(58vh); overflow:auto; padding:8px; }

    /* Task row: minimal + pastel accent for time pill */
    .task-item {
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px; border-radius:10px; background: transparent;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      transition: transform .25s ease, opacity .25s ease;
    }
    .task-item:last-child { border-bottom:none; }

    .task-left { display:flex; gap:10px; align-items:center; min-width:0; }
    .time-pill {
      font-size:12px; padding:6px 10px; border-radius:999px;
      background: linear-gradient(90deg, rgba(124,139,230,0.12), rgba(162,139,230,0.08));
      color:var(--accent-2); font-weight:600; white-space:nowrap;
    }
    .task-name { font-weight:600; font-size:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* actions & 3-dot menu */
    .task-actions { display:flex; align-items:center; gap:6px; }
    .menu-btn { background:none; border:none; font-size:20px; cursor:pointer; color:var(--muted); padding:6px; border-radius:8px; }
    .menu-btn:hover { background: rgba(0,0,0,0.03); color:var(--text); }

    /* floating dropdown */
    .task-menu {
      position: absolute; background: var(--panel); border-radius:10px; box-shadow: var(--shadow);
      z-index:999; overflow:hidden; min-width:130px;
    }
    .task-menu-item { padding:10px 12px; cursor:pointer; font-size:14px; color:var(--text); }
    .task-menu-item:hover{ background: rgba(0,0,0,0.04); }

    /* Modal overlay & content */
    .modal-overlay {
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(2,6,23,0.45); z-index:300;
    }
    .modal-overlay.open { display:flex; }

    .modal {
      width: min(560px, calc(100% - 32px));
      background: var(--panel); border-radius:12px; padding:16px; box-shadow: var(--shadow);
      transform: translateY(-8px); opacity:0; transition: transform .22s ease, opacity .22s ease;
    }
    .modal-overlay.open .modal { transform: translateY(0); opacity:1; }

    .modal h3 { margin:0 0 8px 0; font-size:16px; }
    .modal .row { display:flex; gap:8px; margin-top:10px; }
    .modal input[type="text"], .modal select {
      width:100%; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--text);
    }

    .modal .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:14px; }

    /* Add/remove animations */
    .fade-in { animation: fadeIn .28s ease both; }
    .fade-out { animation: fadeOut .24s ease both; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(8px) } to { opacity:1; transform:none } }
    @keyframes fadeOut { from { opacity:1; transform:none } to { opacity:0; transform: translateY(-8px) } }

    /* Drawer */
    .drawer {
  position: fixed;
  top: 0;
  left: 0;
  transform: translateX(-100%); /* hide off-screen without negative left */
  width: 320px;
  height: 100%;
  background: var(--panel);
  box-shadow: 2px 0 20px rgba(0,0,0,0.12);
  z-index: 200;
  transition: transform .28s ease;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.drawer.open {
  transform: translateX(0); /* slide in */
}
    .drawer-header { display:flex; justify-content:space-between; align-items:center; }
    .drawer-overlay {
      position: fixed; inset:0; background: rgba(0,0,0,0.4); opacity:0; visibility:hidden; z-index:190; transition: opacity .2s;
    }
    .drawer-overlay.active { opacity:1; visibility:visible; }

    label{ display:block; font-size:13px; margin-bottom:6px; color:var(--muted) }
    select{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--text) }

    /* Sidebar */
    aside.sidebar { display:flex; flex-direction:column; gap:12px; }

    /* Responsive adjustments (fix scaling & center) */
    @media (max-width:880px){
  .app {
    grid-template-columns: 1fr;
    margin: 0 auto;
    max-width: 100%;
    padding: 0 8px;
  }
  aside.sidebar { order:2; width:100%; }
  .list-wrap { max-height: calc(46vh); }
  .drawer { width: 84%; transform: translateX(-100%); left: 0; } /* transform hide; left:0 ensures consistent baseline */
  .drawer.open { transform: translateX(0); }
}
     {
  outline: 1px solid red !important;
}
/* --- STRONG FIX: kill horizontal overflow on all devices --- */
html, body {
  width: 100% !important;
  max-width: 100% !important;
  overflow-x: hidden !important;
  position: relative !important;
}

/* Force all children to stay inside viewport */
body * {
  max-width: 100% !important;
  box-sizing: border-box !important;
}

/* App container safe */
.app {
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 auto !important;
  padding: 0 12px !important;
  box-sizing: border-box !important;
  overflow-x: hidden !important;
}

/* Panel safety */
.panel {
  width: 100% !important;
  max-width: 100% !important;
  overflow-x: hidden !important;
}

/* Drawer safe transform */
.drawer {
  left: 0 !important;
  transform: translateX(-100%) !important;
}
.drawer.open {
  transform: translateX(0) !important;
}
/* --- STRONG FIX: kill horizontal overflow on all devices --- */
html, body {
  width: 100% !important;
  max-width: 100% !important;
  overflow-x: hidden !important;
  position: relative !important;
}

/* Force all children to stay inside viewport */
body * {
  max-width: 100% !important;
  box-sizing: border-box !important;
}

/* App container safe */
.app {
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 auto !important;
  padding: 0 12px !important;
  box-sizing: border-box !important;
  overflow-x: hidden !important;
}

/* Panel safety */
.panel {
  width: 100% !important;
  max-width: 100% !important;
  overflow-x: hidden !important;
}

/* Drawer safe transform */
.drawer {
  left: 0 !important;
  transform: translateX(-100%) !important;
}
.drawer.open {
  transform: translateX(0) !important;
}

  </style>
</head>
<body>
  <div class="app" id="app">
    <div>
      <div class="panel">
        <header class="app-header">
          <div class="brand">
            <button id="menuButton" class="hamburger-btn" aria-label="Open settings">
              <svg width="18" height="14" viewBox="0 0 18 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1h16M1 7h16M1 13h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </button>

            <div>
              <h1>Today's Routine</h1>
              <div id="currentDate" class="muted-sm">Loading date...</div>
            </div>
          </div>

          <div class="controls">
            <button id="add-task" class="primary">+ Add Task</button>
          </div>
        </header>

        <!-- Now -->
        <div class="now-card" id="nowCard">
          <div class="now-title">Happening now</div>
          <div class="now-task" id="nowTask">No task â€” relax or add one</div>
          <div class="now-time muted-sm" id="nowTime">--</div>
        </div>

        <!-- Upcoming -->
        <div class="upcoming-card">
          <div class="up-panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="up-title">Upcoming</div>
              <div class="muted-sm">Next few</div>
            </div>
            <div class="up-list" id="upcomingList"></div>
          </div>
        </div>

        <!-- Today's tasks -->
        <div class="today-panel" aria-labelledby="todayTitle">
          <div class="today-header">
            <div style="font-weight:700">Today's tasks</div>
            <div class="muted-sm">Start: <span id="startOfDay">--</span> â€¢ End: <span id="endOfDay">--</span></div>
          </div>
          <div class="divider"></div>
          <div class="list-wrap">
            <div class="task-list" id="taskList"></div>
          </div>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Routines</div>
          <button class="btn" id="newRoutine">New</button>
        </div>
        <div class="routines">
          <select id="routineSelect"></select>
        </div>
        <div class="muted-sm" style="margin-top:8px">Choose a routine to edit its tasks. Routines are saved locally.</div>
      </div>

      <div class="panel">
        <div style="font-weight:700;margin-bottom:8px">Help & Tips</div>
        <div class="muted-sm">Add tasks with clear time ranges. Tap the â€¢â€¢â€¢ on a task to edit or delete it.</div>
      </div>
    </aside>
  </div>

  <!-- Modal overlay (reused for Add/Edit Task & New Routine) -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-hidden="true">
    <div class="modal" id="modalContent" role="document"></div>
  </div>

  <!-- Drawer & overlay -->
  <div id="settingsDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <h2>Settings</h2>
      <button id="closeDrawer" class="close-btn" aria-label="Close settings">&times;</button>
    </div>

    <div class="drawer-content">
      <div>
        <label for="timeFormatSelect">Time format</label>
        <select id="timeFormatSelect">
          <option value="12">12-hour (AM/PM)</option>
          <option value="24">24-hour</option>
        </select>
      </div>

      <div>
        <label for="themeSelect">Theme</label>
        <select id="themeSelect">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>
  </div>
  <div id="drawerOverlay" class="drawer-overlay" aria-hidden="true"></div>

  <script>
    /* -------------------------
       Data / Storage / Helpers
    ------------------------- */
    const KEY = 'adhd_routines_v1';
    const KEY_SETTINGS = 'adhd_routines_settings_v1';

    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const genId = () => 'id_' + Math.random().toString(36).slice(2,9);

    const defaultData = {
      routines:[{
        id: genId(),
        name: 'Weekdays',
        tasks:[
          {id: genId(), name:'Wake up',start:'07:00',end:'07:30'},
          {id: genId(), name:'Morning routine',start:'07:30',end:'08:15'},
          {id: genId(), name:'Commute / Prep',start:'08:15',end:'09:30'},
          {id: genId(), name:'Office work',start:'10:00',end:'13:00'},
          {id: genId(), name:'Lunch',start:'13:00',end:'14:00'},
          {id: genId(), name:'Afternoon work',start:'14:00',end:'18:00'},
          {id: genId(), name:'Evening unwind',start:'20:00',end:'22:00'},
        ]
      }]
    };

    const defaultSettings = { timeFormat:'12', theme:'light', selectedRoutineId:null };

    function loadState(){ try { const s = localStorage.getItem(KEY); return s ? JSON.parse(s) : null } catch(e){ return null } }
    function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)) }
    function loadSettings(){ try { const s = localStorage.getItem(KEY_SETTINGS); return s ? JSON.parse(s) : null } catch(e){ return null } }
    function saveSettings(){ localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)) }

    let state = loadState();
    let settings = loadSettings();
    if(!state){ state = defaultData; saveState(); }
    if(!settings){ settings = defaultSettings; saveSettings(); }
    if(!settings.selectedRoutineId){ settings.selectedRoutineId = state.routines[0].id; saveSettings(); }

    /* -------------------------
       Elements
    ------------------------- */
    const routineSelect = qs('#routineSelect');
    const taskList = qs('#taskList');
    const upcomingList = qs('#upcomingList');
    const nowTask = qs('#nowTask');
    const nowTime = qs('#nowTime');
    const startOfDayEl = qs('#startOfDay');
    const endOfDayEl = qs('#endOfDay');
    const currentDateEl = qs('#currentDate');

    // drawer
    const menuButton = qs('#menuButton');
    const settingsDrawer = qs('#settingsDrawer');
    const drawerOverlay = qs('#drawerOverlay');
    const closeDrawer = qs('#closeDrawer');
    const themeSelect = qs('#themeSelect');
    const timeFormatSelect = qs('#timeFormatSelect');

    // modal
    const modalOverlay = qs('#modalOverlay');
    const modalContent = qs('#modalContent');

    /* -------------------------
       UI Initialization
    ------------------------- */
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t === 'dark' ? 'dark' : 'light') }
    applyTheme(settings.theme);
    if(themeSelect) themeSelect.value = settings.theme;
    if(timeFormatSelect) timeFormatSelect.value = settings.timeFormat;

    // date
    function setCurrentDate(){
      const today = new Date();
      const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
      currentDateEl.textContent = today.toLocaleDateString(undefined, opts);
    }
    setCurrentDate();

    // render routines options
    function renderRoutineOptions(){
      routineSelect.innerHTML = '';
      state.routines.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id; opt.textContent = r.name;
        if(settings.selectedRoutineId === r.id) opt.selected = true;
        routineSelect.appendChild(opt);
      });
    }

    function currentRoutine(){ return state.routines.find(r => r.id === settings.selectedRoutineId) || state.routines[0]; }

    /* -------------------------
       Time helpers
    ------------------------- */
    function getNowMinutes(){ const d = new Date(); return d.getHours()*60 + d.getMinutes() }
    function timeToMinutes(t){ if(!t) return 0; const [hh,mm] = t.split(':').map(Number); return hh*60 + mm }
    function formatTime(t){
      if(!t) return '--';
      const [hh,mm] = t.split(':').map(Number);
      if(settings.timeFormat === '24') return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
      const am = hh < 12; const h12 = ((hh+11)%12)+1;
      return `${h12}:${String(mm).padStart(2,'0')} ${am?'AM':'PM'}`;
    }

    /* -------------------------
       Rendering
    ------------------------- */
    function renderAll(){ renderRoutineOptions(); renderTaskList(); renderUpcoming(); updateNowView(); }

    function renderUpcoming(){
      const routine = currentRoutine();
      upcomingList.innerHTML = '';
      if(!routine) return;
      const now = getNowMinutes();
      const upcoming = routine.tasks.filter(t => timeToMinutes(t.start) >= now).slice(0,6);
      if(upcoming.length === 0){
        const p = document.createElement('div'); p.className='muted-sm'; p.textContent = 'No upcoming tasks';
        upcomingList.appendChild(p); return;
      }
      upcoming.forEach(t => {
        const row = document.createElement('div'); row.className = 'up-item';
        const left = document.createElement('div'); left.textContent = t.name;
        const right = document.createElement('div'); right.className = 'muted'; right.textContent = formatTime(t.start);
        row.appendChild(left); row.appendChild(right); upcomingList.appendChild(row);
      });
    }

    function renderTaskList(){
      const routine = currentRoutine();
      if(!routine) return;

      // sort by start
      routine.tasks.sort((a,b) => timeToMinutes(a.start) - timeToMinutes(b.start));

      // update start/end
      if(routine.tasks.length){
        startOfDayEl.textContent = formatTime(routine.tasks[0].start);
        endOfDayEl.textContent = formatTime(routine.tasks[routine.tasks.length-1].end);
      } else { startOfDayEl.textContent='--'; endOfDayEl.textContent='--'; }

      // snapshot for reposition animation
      const oldNodes = Array.from(taskList.children);
      const oldRects = oldNodes.map(n => n.getBoundingClientRect());

      taskList.innerHTML = '';

      routine.tasks.forEach(task => {
        const row = document.createElement('div');
        row.className = 'task-item fade-in';
        row.dataset.id = task.id;

        const left = document.createElement('div'); left.className = 'task-left';
        const timePill = document.createElement('div'); timePill.className='time-pill';
        timePill.textContent = `${formatTime(task.start)} â†’ ${formatTime(task.end)}`;
        const name = document.createElement('div'); name.className = 'task-name'; name.textContent = task.name;

        left.appendChild(timePill); left.appendChild(name);

        const actions = document.createElement('div'); actions.className = 'task-actions';
        const menuBtn = document.createElement('button');
        menuBtn.className = 'menu-btn';
        menuBtn.innerHTML = '&#8942;';
        menuBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleTaskMenu(task.id, menuBtn); });

        actions.appendChild(menuBtn);

        row.appendChild(left); row.appendChild(actions);
        taskList.appendChild(row);
      });

      // simple reposition animation
      const newNodes = Array.from(taskList.children);
      newNodes.forEach(node => {
        const old = oldNodes.find(n => n.dataset.id === node.dataset.id);
        if(old){
          const oldRect = oldRects[oldNodes.indexOf(old)];
          const newRect = node.getBoundingClientRect();
          const dy = oldRect.top - newRect.top;
          if(Math.abs(dy) > 1){
            node.style.transform = `translateY(${dy}px)`;
            requestAnimationFrame(() => { node.style.transition = 'transform .35s cubic-bezier(.2,.9,.2,1)'; node.style.transform = ''; });
          }
        }
      });

      renderUpcoming();
    }

    function updateNowView(){
      const routine = currentRoutine();
      const nowM = getNowMinutes();
      let current = null, next = null;
      if(routine){
        for(const t of routine.tasks){
          const s = timeToMinutes(t.start), e = timeToMinutes(t.end);
          if(nowM >= s && nowM < e){ current = t; break; }
          if(s > nowM && !next){ next = t; }
        }
      }
      if(current){
        nowTask.textContent = current.name;
        nowTime.textContent = `${formatTime(current.start)} â†’ ${formatTime(current.end)}`;
      } else if(next){
        nowTask.textContent = 'No current task';
        nowTime.textContent = `Next: ${next.name} â€¢ ${formatTime(next.start)}`;
      } else {
        nowTask.textContent = 'No current task';
        nowTime.textContent = 'You are between routines â€” consider adding a task';
      }
      // keep list in sync
      renderTaskList();
    }

    /* -------------------------
       Add / Edit / Delete (modals)
       --- with custom time pickers
    ------------------------- */
    // helper: create time picker selects inside a container selector
    function createTimePicker(containerSelector, initTime){
      const container = document.querySelector(containerSelector);
      container.innerHTML = ''; // clear

      // hour select
      const hourSel = document.createElement('select');
      hourSel.className = 'time-select';
      hourSel.style.width = '100%';

      // minute select
      const minuteSel = document.createElement('select');
      minuteSel.className = 'time-select';
      minuteSel.style.width = '100%';

      // am/pm for 12hr
      let ampmSel = null;

      if(settings.timeFormat === '24'){
        for(let h=0; h<24; h++){
          const opt = document.createElement('option');
          opt.value = String(h).padStart(2,'0');
          opt.textContent = String(h).padStart(2,'0');
          hourSel.appendChild(opt);
        }
      } else {
        for(let h=1; h<=12; h++){
          const opt = document.createElement('option');
          opt.value = String(h).padStart(2,'0');
          opt.textContent = String(h);
          hourSel.appendChild(opt);
        }
        ampmSel = document.createElement('select');
        ampmSel.className = 'time-select';
        ampmSel.style.width = '100%';
        const o1 = document.createElement('option'); o1.value='AM'; o1.textContent='AM';
        const o2 = document.createElement('option'); o2.value='PM'; o2.textContent='PM';
        ampmSel.appendChild(o1); ampmSel.appendChild(o2);
      }

      // minutes 00 - 59
      for(let m=0; m<60; m++){
        const opt = document.createElement('option');
        opt.value = String(m).padStart(2,'0');
        opt.textContent = String(m).padStart(2,'0');
        minuteSel.appendChild(opt);
      }

      // layout: columns stack mobile -> we will append hour/minute/ampm
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.gap = '8px';
      wrap.style.alignItems = 'center';

      hourSel.style.flex = '1';
      minuteSel.style.flex = '1';

      wrap.appendChild(hourSel);
      wrap.appendChild(minuteSel);
      if(ampmSel){ ampmSel.style.flex='0.7'; wrap.appendChild(ampmSel); }

      container.appendChild(wrap);

      // prefill if initTime given (initTime stored as "HH:MM" 24h)
      if(initTime){
        const [hhStr, mmStr] = initTime.split(':');
        const hh = Number(hhStr);
        const mm = String(mmStr).padStart(2,'0');
        if(settings.timeFormat === '24'){
          hourSel.value = String(hh).padStart(2,'0');
        } else {
          const am = hh < 12;
          let h12 = ((hh + 11) % 12) + 1; // convert 24->12
          hourSel.value = String(h12).padStart(2,'0');
          ampmSel.value = am ? 'AM' : 'PM';
        }
        minuteSel.value = mm;
      } else {
        // default to common times (current time rounded)
        const now = new Date();
        let hh = now.getHours();
        let mm = now.getMinutes();
        mm = String(mm).padStart(2,'0');
        if(settings.timeFormat === '24'){
          hourSel.value = String(hh).padStart(2,'0');
        } else {
          const am = hh < 12;
          let h12 = ((hh + 11) % 12) + 1;
          hourSel.value = String(h12).padStart(2,'0');
          ampmSel.value = am ? 'AM' : 'PM';
        }
        minuteSel.value = mm;
      }

      return { hourSel, minuteSel, ampmSel };
    }

    // convert picker values to 24hr "HH:MM"
    function pickerTo24(timePickerObj){
      const hhRaw = timePickerObj.hourSel.value;
      const mmRaw = timePickerObj.minuteSel.value;
      if(settings.timeFormat === '24'){
        return `${String(hhRaw).padStart(2,'0')}:${String(mmRaw).padStart(2,'0')}`;
      } else {
        // hhRaw is 01-12, ampm decides
        let hh = Number(hhRaw);
        const isPM = timePickerObj.ampmSel && timePickerObj.ampmSel.value === 'PM';
        if(hh === 12){
          hh = isPM ? 12 : 0;
        } else {
          hh = isPM ? hh + 12 : hh;
        }
        return `${String(hh).padStart(2,'0')}:${String(mmRaw).padStart(2,'0')}`;
      }
    }

    // Open add task
    qs('#add-task').addEventListener('click', ()=> openTaskModal());

    function openTaskModal(task = null){
      // build modal HTML
      const isEdit = !!task;
      modalContent.innerHTML = `
        <h3>${isEdit ? 'Edit Task' : 'Add Task'}</h3>
        <div class="row">
          <input id="modalTaskName" type="text" placeholder="Task name (e.g., Office work)" />
        </div>
        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label style="margin-bottom:6px;font-size:13px;color:var(--muted)">Start time</label>
            <div id="modalStartPicker"></div>
          </div>
          <div style="flex:1">
            <label style="margin-bottom:6px;font-size:13px;color:var(--muted)">End time</label>
            <div id="modalEndPicker"></div>
          </div>
        </div>
        <div class="actions">
          <button id="modalCancel" class="btn">Cancel</button>
          <button id="modalSave" class="primary">${isEdit ? 'Save' : 'Add'}</button>
        </div>
      `;

      // create pickers
      const startPickerObj = createTimePicker('#modalStartPicker', task ? task.start : null);
      const endPickerObj = createTimePicker('#modalEndPicker', task ? task.end : null);

      // prefill name
      if(isEdit) qs('#modalTaskName').value = task.name; else qs('#modalTaskName').value = '';

      // show modal
      openModal();

      // events
      qs('#modalCancel').addEventListener('click', closeModal);
      qs('#modalSave').addEventListener('click', ()=>{
        const nm = qs('#modalTaskName').value.trim();
        const st = pickerTo24(startPickerObj);
        const ed = pickerTo24(endPickerObj);
        if(!nm || !st || !ed){ alert('Please provide a name, start and end time'); return; }
        if(timeToMinutes(ed) <= timeToMinutes(st)){ alert('End time must be after start time'); return; }
        const routine = currentRoutine();
        if(isEdit){
          const tObj = routine.tasks.find(x=>x.id===task.id);
          tObj.name = nm; tObj.start = st; tObj.end = ed;
        } else {
          routine.tasks.push({ id: genId(), name: nm, start: st, end: ed });
        }
        saveState();
        closeModal();
        renderAll();
      });
    }

    // Open new routine modal
    qs('#newRoutine').addEventListener('click', openNewRoutine);
    function openNewRoutine(){
      modalContent.innerHTML = `
        <h3>Create Routine</h3>
        <div class="row">
          <input id="modalRoutineName" type="text" placeholder="Routine name (e.g., Weekends)" />
        </div>
        <div class="actions">
          <button id="routineCancel" class="btn">Cancel</button>
          <button id="routineSave" class="primary">Create</button>
        </div>
      `;
      openModal();
      qs('#routineCancel').addEventListener('click', closeModal);
      qs('#routineSave').addEventListener('click', ()=>{
        const name = qs('#modalRoutineName').value.trim();
        if(!name) return alert('Please name the routine');
        const r = { id: genId(), name, tasks: [] };
        state.routines.push(r); saveState();
        settings.selectedRoutineId = r.id; saveSettings();
        closeModal();
        renderAll();
      });
    }

    // modal open/close helpers
    function openModal(){
      modalOverlay.classList.add('open');
      modalOverlay.setAttribute('aria-hidden','false');
      setTimeout(()=> {
        const firstInput = modalContent.querySelector('input,select,button');
        if(firstInput) firstInput.focus();
      }, 120);
    }
    function closeModal(){
      modalOverlay.classList.remove('open');
      modalOverlay.setAttribute('aria-hidden','true');
      modalContent.innerHTML = '';
    }
    // clicking overlay closes modal (but not clicks inside)
    modalOverlay.addEventListener('click', (e) => {
      if(e.target === modalOverlay) closeModal();
    });

    function deleteTask(id){
      if(!confirm('Delete this task?')) return;
      const routine = currentRoutine();
      const node = taskList.querySelector(`[data-id="${id}"]`);
      if(node){
        node.classList.add('fade-out');
        node.addEventListener('animationend', () => {
          routine.tasks = routine.tasks.filter(t=>t.id!==id);
          saveState();
          renderAll();
        }, { once:true });
      } else {
        routine.tasks = routine.tasks.filter(t=>t.id!==id);
        saveState();
        renderAll();
      }
    }

    /* -------------------------
       Task menu (3-dot) dropdown
    ------------------------- */
    function toggleTaskMenu(taskId, button){
      // close any
      qsa('.task-menu').forEach(m => m.remove());

      const menu = document.createElement('div');
      menu.className = 'task-menu';
      menu.innerHTML = `<div class="task-menu-item" data-action="edit">Edit</div><div class="task-menu-item" data-action="delete">Delete</div>`;
      document.body.appendChild(menu);

      // position near button, keep inside viewport
      const rect = button.getBoundingClientRect();
      const left = Math.max(8, rect.left + window.scrollX - 120);
      const top = rect.bottom + window.scrollY + 8;
      menu.style.left = left + 'px';
      menu.style.top = top + 'px';

      menu.querySelector('[data-action="edit"]').addEventListener('click', ()=>{
        const routine = currentRoutine();
        const t = routine.tasks.find(x => x.id === taskId);
        if(t) openTaskModal(t);
        menu.remove();
      });
      menu.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
        deleteTask(taskId);
        menu.remove();
      });

      // close on outside click
      setTimeout(()=> {
        document.addEventListener('click', ()=> menu.remove(), { once:true });
      }, 10);
    }

    /* -------------------------
       Drawer logic & settings
    ------------------------- */
    menuButton.addEventListener('click', ()=>{
      settingsDrawer.classList.add('open');
      drawerOverlay.classList.add('active');
      settingsDrawer.setAttribute('aria-hidden','false');
    });
    function closeSettingsDrawer(){
      settingsDrawer.classList.remove('open');
      drawerOverlay.classList.remove('active');
      settingsDrawer.setAttribute('aria-hidden','true');
    }
    closeDrawer.addEventListener('click', closeSettingsDrawer);
    drawerOverlay.addEventListener('click', closeSettingsDrawer);

    // settings listeners (drawer only)
    timeFormatSelect.addEventListener('change', (e) => {
      settings.timeFormat = e.target.value;
      saveSettings();
      renderAll();
    });
    themeSelect.addEventListener('change', (e) => {
      settings.theme = e.target.value;
      saveSettings();
      applyTheme(settings.theme);
    });

    // routine select change
    routineSelect.addEventListener('change', (e) => {
      settings.selectedRoutineId = e.target.value;
      saveSettings();
      renderAll();
    });

    /* -------------------------
       Initialise & update loop
    ------------------------- */
    // ensure keys exist
    saveState(); saveSettings();

    // SW registration (if exists)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./service-worker.js').then(()=>console.log('SW registered')).catch(()=>console.log('SW fail'));
    }

    // periodic updates for "now"
    setInterval(updateNowView, 30000);

    // initial render
    renderAll();

  </script>
</body>
</html>
