<!doctype html>
<html lang="en">
<head>
  <meta name="theme-color" content="#6366f1" />
  <meta charset="utf-8" />
  <!-- Mobile-first, disable zooming as you requested -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Today's Routine</title>
  <link rel="manifest" href="manifest.json" />
  
  <style>
    /* ========== THEME TOKENS (pastel light / muted dark) ========== */
    :root{
      --bg: #f7fafc;           /* page background */
      --panel: #ffffff;        /* cards/panels */
      --text: #0f172a;         /* high contrast text */
      --muted: #6b7280;        /* secondary text */
      --accent: #7c8de6;       /* pastel indigo */
      --accent-2: #a28be6;     /* pastel purple */
      --glass: rgba(255,255,255,0.65);
      --shadow: 0 10px 26px rgba(16,24,40,0.06);
      --radius: 14px;
      --danger: #ef476f;
    }
    [data-theme="dark"]{
      --bg: #0a1229;
      --panel: #0b1430;
      --text: #e8eef8;
      --muted: #9aa8c0;
      --accent: #5f6df3;
      --accent-2: #8b5cf6;
      --glass: rgba(255,255,255,0.06);
      --shadow: 0 16px 40px rgba(2,6,23,0.65);
    }

    /* ========== GLOBAL RESET & MOBILE SAFETY ========== */
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      width: 100%;
      overflow-x: hidden;             /* kill any side scroll on mobile */
      -webkit-overflow-scrolling: touch;
      background: var(--bg);
    }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========== LAYOUT (MOBILE-FIRST) ========== */
    .wrap {
      width: 100%;
      max-width: 720px;               /* nice readable width */
      margin: 0 auto;
      padding: 10px 14px 24px;        /* small side padding that never overflows */
    }
    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      width: 100%;
      max-width: 100%;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }
    h1 {
      font-size: 16px;
      line-height: 1.2;
      margin: 0 0 2px 0;
    }
    .muted-sm { color: var(--muted); font-size: 13px; }
    .hamburger {
      width: 44px; height: 44px;
      display: inline-grid; place-items: center;
      border: 1px solid rgba(0,0,0,0.06);
      background: transparent;
      color: var(--text);
      border-radius: 12px;
    }
    .primary {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border: none; color: #fff; font-weight: 700;
      padding: 10px 14px; border-radius: 12px;
    }

    /* Now */
    .now {
      padding: 16px;
      border-radius: 12px;
      background: linear-gradient(90deg, rgba(124,139,230,0.10), rgba(162,139,230,0.06));
      margin-bottom: 12px;
    }
    .now .title { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .now .task  { font-size: 18px; font-weight: 800; }
    .now .time  { font-size: 13px; color: var(--muted); margin-top: 6px; }

    /* Upcoming */
    .upcoming { margin-bottom: 12px; }
    .up-title { font-weight: 800; }
    .up-list  { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
    .up-item {
      display:flex; justify-content: space-between; align-items: center;
      background: rgba(0,0,0,0.03);
      padding: 10px 12px; border-radius: 10px;
    }
    .up-time  { color: var(--muted); font-size: 13px; }

    /* Today’s tasks */
    .today .header-row {
      display:flex; justify-content: space-between; align-items: center;
      padding: 6px 4px 10px;
    }
    .divider { height:1px; width:100%; background: rgba(0,0,0,0.06); border-radius: 4px; }
    .list-wrap { max-height: 60vh; overflow: auto; padding: 8px 4px; }

    .task {
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; padding: 10px 6px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .task:last-child { border-bottom: none; }
    .task-left { display:flex; align-items:center; gap: 10px; min-width: 0; }
    .time-pill {
      font-size: 12px; font-weight: 700;
      padding: 6px 10px; border-radius: 999px;
      white-space: nowrap;
      background: linear-gradient(90deg, rgba(124,139,230,0.16), rgba(162,139,230,0.10));
      color: var(--accent-2);
    }
    .task-name {
      font-weight: 700; font-size: 15px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .task-actions { display:flex; align-items:center; }
    .menu-btn {
      border: none; background: transparent; color: var(--muted);
      font-size: 20px; padding: 6px 8px; border-radius: 10px;
    }
    .menu-btn:active { background: rgba(0,0,0,0.06); }

    /* floating dropdown menu */
    .menu {
      position: absolute; z-index: 9999;
      background: var(--panel);
      border-radius: 12px; box-shadow: var(--shadow);
      overflow: hidden; min-width: 140px;
    }
    .menu-item { padding: 10px 12px; font-size: 14px; }
    .menu-item:active { background: rgba(0,0,0,0.06); }

    /* Drawer (settings only) */
    .drawer {
      position: fixed; inset: 0 auto 0 0;      /* left edge */
      width: 86vw; max-width: 360px; height: 100%;
      background: var(--panel); box-shadow: 8px 0 30px rgba(0,0,0,0.22);
      transform: translateX(-100%); transition: transform .26s ease;
      z-index: 300; padding: 16px; display:flex; flex-direction:column; gap: 12px;
    }
    .drawer.open { transform: translateX(0); }
    .drawer-overlay {
      position: fixed; inset: 0;
      background: rgba(2,6,23,0.45);
      opacity: 0; visibility: hidden; transition: opacity .18s ease;
      z-index: 290;
    }
    .drawer-overlay.active { opacity: 1; visibility: visible; }
    .drawer h2 { margin: 0 0 8px 0; }

    label { display:block; font-size:13px; color: var(--muted); margin-bottom: 6px; }
    select, input[type="text"] {
      width: 100%; padding: 10px; border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08); background: transparent; color: var(--text);
    }

    /* Modal (add/edit task & new routine) */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 400;
      display: none; align-items: center; justify-content: center;
      background: rgba(2,6,23,0.45);
    }
    .modal-overlay.open { display: flex; }
    .modal {
      width: min(560px, calc(100% - 28px));
      background: var(--panel); color: var(--text);
      border-radius: 14px; box-shadow: var(--shadow);
      padding: 16px; transform: translateY(6px); opacity: 0;
      transition: transform .2s ease, opacity .2s ease;
    }
    .modal-overlay.open .modal { transform: translateY(0); opacity: 1; }
    .row { display:flex; gap: 8px; }
    .row > * { flex: 1; }
    .actions { display:flex; justify-content: flex-end; gap: 8px; margin-top: 12px; }
    .btn { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.08); background: transparent; color: var(--text); }
    .btn.danger { border-color: transparent; background: #ffe6ea; color: #a30023; }

    /* Subtle enter/exit animations for task rows */
    .fade-in { animation: fadeIn .24s ease both; }
    .fade-out { animation: fadeOut .20s ease both; }
    @keyframes fadeIn { from { opacity:.01; transform: translateY(8px) } to { opacity:1; transform: none } }
    @keyframes fadeOut { from { opacity:1; transform:none } to { opacity:.01; transform: translateY(-8px) } }

    /* Desktop nicety (no layout change; just centers content) */
    @media (min-width: 980px){
      .wrap { padding-left: 24px; padding-right: 24px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- HEADER -->
    <div class="panel">
      <header class="header">
        <div class="brand">
          <button id="menuBtn" class="hamburger" aria-label="Open settings">
            <svg width="18" height="14" viewBox="0 0 18 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 1h16M1 7h16M1 13h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </button>
          <div>
            <h1>Today's Routine</h1>
            <div id="currentDate" class="muted-sm">Loading date…</div>
          </div>
        </div>
        <button id="addTask" class="primary">+ Add Task</button>
      </header>

      <!-- HAPPENING NOW -->
      <section class="now" id="nowCard">
        <div class="title">Happening now</div>
        <div class="task" id="nowTask">No task — relax or add one</div>
        <div class="time" id="nowTime">--</div>
      </section>

      <!-- UPCOMING -->
      <section class="upcoming">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="up-title">Upcoming</div>
          <div class="up-time">Next few</div>
        </div>
        <div class="up-list" id="upcomingList"></div>
      </section>

      <!-- TODAY -->
      <section class="today panel" style="margin-top: 8px;">
        <div class="header-row">
          <div style="font-weight: 800;">Today's tasks</div>
          <div class="muted-sm">Start: <span id="startOfDay">--</span> • End: <span id="endOfDay">--</span></div>
        </div>
        <div class="divider"></div>
        <div class="list-wrap">
          <div id="taskList"></div>
        </div>
      </section>

      <!-- ROUTINES (bottom) -->
      <section class="panel" style="margin-top: 12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800">Routines</div>
          <button id="newRoutine" class="btn">New</button>
        </div>
        <select id="routineSelect"></select>
        <div class="muted-sm" style="margin-top:8px">Choose a routine to view/edit tasks. Data is saved locally.</div>
      </section>
    </div>
  </div>

  <!-- SETTINGS DRAWER -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Settings</h2>
      <button id="closeDrawer" class="btn" aria-label="Close">Close</button>
    </div>
    <div>
      <label for="timeFormatSelect">Time format</label>
      <select id="timeFormatSelect">
        <option value="12">12-hour (AM/PM)</option>
        <option value="24">24-hour</option>
      </select>
    </div>
    <div>
      <label for="themeSelect">Theme</label>
      <select id="themeSelect">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </div>
  </aside>
  <div id="drawerOverlay" class="drawer-overlay" aria-hidden="true"></div>

  <!-- MODAL (reused for Add/Edit Task and New Routine) -->
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <script>
    /* =================== STATE =================== */
    const KEY = 'adhd_routines_v2';
    const KEY_SETTINGS = 'adhd_routines_settings_v2';
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const genId = () => 'id_' + Math.random().toString(36).slice(2,9);

    const defaultData = {
      routines:[{
        id: genId(), name: 'Weekdays',
        tasks: [
          {id: genId(), name:'Wake up', start:'07:00', end:'07:30'},
          {id: genId(), name:'Morning routine', start:'07:30', end:'08:15'},
          {id: genId(), name:'Commute / Prep', start:'08:15', end:'09:30'},
          {id: genId(), name:'Office work', start:'10:00', end:'13:00'},
          {id: genId(), name:'Lunch', start:'13:00', end:'14:00'},
          {id: genId(), name:'Afternoon work', start:'14:00', end:'18:00'},
          {id: genId(), name:'Evening unwind', start:'20:00', end:'22:00'},
        ]
      }]
    };
    const defaultSettings = { timeFormat:'12', theme:'light', selectedRoutineId:null };

    let state = null, settings = null;
    try { state = JSON.parse(localStorage.getItem(KEY)) } catch(_) {}
    try { settings = JSON.parse(localStorage.getItem(KEY_SETTINGS)) } catch(_) {}
    if(!state){ state = defaultData; localStorage.setItem(KEY, JSON.stringify(state)) }
    if(!settings){ settings = defaultSettings; localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)) }
    if(!settings.selectedRoutineId){ settings.selectedRoutineId = state.routines[0].id; localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)) }

    function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)) }
    function saveSettings(){ localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)) }

    /* =================== ELEMENTS =================== */
    const addTaskBtn = qs('#addTask');
    const nowTaskEl = qs('#nowTask');
    const nowTimeEl = qs('#nowTime');
    const currentDateEl = qs('#currentDate');
    const upList = qs('#upcomingList');
    const taskList = qs('#taskList');
    const startOfDayEl = qs('#startOfDay');
    const endOfDayEl = qs('#endOfDay');
    const routineSelect = qs('#routineSelect');
    const newRoutineBtn = qs('#newRoutine');

    // Drawer & settings
    const drawer = qs('#drawer');
    const drawerOverlay = qs('#drawerOverlay');
    const menuBtn = qs('#menuBtn');
    const closeDrawerBtn = qs('#closeDrawer');
    const timeFormatSelect = qs('#timeFormatSelect');
    const themeSelect = qs('#themeSelect');

    // Modal
    const modalOverlay = qs('#modalOverlay');
    const modal = qs('#modal');

    /* =================== HELPERS =================== */
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t === 'dark' ? 'dark' : 'light');
    }
    function setToday(){ currentDateEl.textContent = new Date().toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'}) }

    applyTheme(settings.theme);
    setToday();
    timeFormatSelect.value = settings.timeFormat;
    themeSelect.value = settings.theme;

    function currentRoutine(){ return state.routines.find(r => r.id === settings.selectedRoutineId) || state.routines[0]; }
    function timeToMin(t){ const [h,m] = t.split(':').map(Number); return h*60 + m }
    function minToTime(m){ const hh = Math.floor(m/60), mm = m%60; return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}` }
    function fmt(t){
      const [h,m] = t.split(':').map(Number);
      if(settings.timeFormat === '24') return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      const am = h < 12; const h12 = ((h + 11) % 12) + 1;
      return `${h12}:${String(m).padStart(2,'0')} ${am?'AM':'PM'}`;
    }

    /* =================== RENDER =================== */
    function renderRoutineOptions(){
      routineSelect.innerHTML = '';
      state.routines.forEach(r => {
        const o = document.createElement('option');
        o.value = r.id; o.textContent = r.name;
        if(r.id === settings.selectedRoutineId) o.selected = true;
        routineSelect.appendChild(o);
      });
    }

    function renderUpcoming(){
      const r = currentRoutine(); if(!r) return;
      const now = new Date(); const cur = now.getHours()*60 + now.getMinutes();
      const list = r.tasks.filter(t => timeToMin(t.start) >= cur).slice(0,6);
      upList.innerHTML = '';
      if(list.length === 0){ const d = document.createElement('div'); d.className='muted-sm'; d.textContent='No upcoming tasks'; upList.appendChild(d); return; }
      list.forEach(t => {
        const row = document.createElement('div'); row.className='up-item';
        const name = document.createElement('div'); name.textContent = t.name;
        const time = document.createElement('div'); time.className='up-time'; time.textContent = fmt(t.start);
        row.appendChild(name); row.appendChild(time); upList.appendChild(row);
      });
    }

    function renderTasks(){
      const r = currentRoutine(); if(!r) return;
      // sort by start
      r.tasks.sort((a,b) => timeToMin(a.start) - timeToMin(b.start));

      // start/end of day
      if(r.tasks.length){ startOfDayEl.textContent = fmt(r.tasks[0].start); endOfDayEl.textContent = fmt(r.tasks[r.tasks.length-1].end) }
      else { startOfDayEl.textContent = endOfDayEl.textContent = '--' }

      // snapshot old nodes for gentle reflow
      const old = Array.from(taskList.children);
      const oldRect = old.map(n => n.getBoundingClientRect());

      taskList.innerHTML = '';
      r.tasks.forEach(t => {
        const row = document.createElement('div'); row.className='task fade-in'; row.dataset.id = t.id;

        const left = document.createElement('div'); left.className='task-left';
        const pill = document.createElement('div'); pill.className='time-pill'; pill.textContent = `${fmt(t.start)} → ${fmt(t.end)}`;
        const name = document.createElement('div'); name.className='task-name'; name.textContent = t.name;
        left.appendChild(pill); left.appendChild(name);

        const actions = document.createElement('div'); actions.className='task-actions';
        const menuBtn = document.createElement('button'); menuBtn.className='menu-btn'; menuBtn.innerHTML='&#8942;';
        menuBtn.addEventListener('click', (e)=> { e.stopPropagation(); showTaskMenu(t.id, menuBtn) });
        actions.appendChild(menuBtn);

        row.appendChild(left); row.appendChild(actions);
        taskList.appendChild(row);
      });

      // gentle position animation
      const neu = Array.from(taskList.children);
      neu.forEach(n => {
        const prev = old.find(o => o.dataset.id === n.dataset.id);
        if(prev){
          const pr = oldRect[old.indexOf(prev)];
          const nr = n.getBoundingClientRect();
          const dy = pr.top - nr.top;
          if(Math.abs(dy) > 1){
            n.style.transform = `translateY(${dy}px)`;
            requestAnimationFrame(()=> { n.style.transition='transform .3s cubic-bezier(.2,.9,.2,1)'; n.style.transform=''; });
          }
        }
      });

      renderUpcoming();
    }

    function renderNow(){
      const r = currentRoutine(); if(!r) return;
      const cur = new Date(); const nowM = cur.getHours()*60 + cur.getMinutes();
      let current=null, next=null;
      for(const t of r.tasks){
        const s = timeToMin(t.start), e = timeToMin(t.end);
        if(nowM >= s && nowM < e){ current = t; break; }
        if(s > nowM && !next){ next = t; }
      }
      if(current){ nowTaskEl.textContent = current.name; nowTimeEl.textContent = `${fmt(current.start)} → ${fmt(current.end)}`; }
      else if(next){ nowTaskEl.textContent = 'No current task'; nowTimeEl.textContent = `Next: ${next.name} • ${fmt(next.start)}`; }
      else { nowTaskEl.textContent='No current task'; nowTimeEl.textContent='You’re between routines — add one'; }

      renderTasks();
    }

    function renderAll(){
      renderRoutineOptions();
      renderNow();
    }

    /* =================== MENUS & MODALS =================== */
    function clamp(val, min, max){ return Math.max(min, Math.min(max, val)) }

    function showTaskMenu(taskId, anchorBtn){
      // close existing
      qsa('.menu').forEach(m => m.remove());

      const m = document.createElement('div');
      m.className = 'menu';
      m.innerHTML = `<div class="menu-item" data-a="edit">Edit</div><div class="menu-item" data-a="delete">Delete</div>`;
      document.body.appendChild(m);

      // position near button and keep inside viewport
      const r = anchorBtn.getBoundingClientRect();
      const vw = window.innerWidth;
      const left = clamp(r.left + window.scrollX - 100, 8, vw - 160);
      const top = r.bottom + window.scrollY + 6;
      m.style.left = left + 'px';
      m.style.top = top + 'px';

      m.querySelector('[data-a="edit"]').onclick = ()=> { const t = currentRoutine().tasks.find(x => x.id===taskId); openTaskModal(t); m.remove(); };
      m.querySelector('[data-a="delete"]').onclick = ()=> { deleteTask(taskId); m.remove(); };

      setTimeout(()=> document.addEventListener('click', ()=> m.remove(), {once:true}), 0);
    }

    function openModal(html){
      modal.innerHTML = html;
      modalOverlay.classList.add('open');
      modalOverlay.setAttribute('aria-hidden','false');
      // focus first input/select
      setTimeout(()=> {
        const f = modal.querySelector('input,select,button'); if(f) f.focus();
      }, 120);
    }
    function closeModal(){
      modalOverlay.classList.remove('open');
      modalOverlay.setAttribute('aria-hidden','true');
      modal.innerHTML = '';
    }
    modalOverlay.addEventListener('click', (e)=> { if(e.target === modalOverlay) closeModal() });

    // Scrollable HH:MM picker factory (respects 12/24)
    function buildTimePicker(init24){
      const wrap = document.createElement('div'); wrap.className='row'; // horizontal on wide, stacks on narrow
      const hour = document.createElement('select');
      const minute = document.createElement('select');
      hour.style.height = minute.style.height = '42px';

      let ampm = null;

      if(settings.timeFormat === '24'){
        for(let h=0; h<24; h++){
          const o = document.createElement('option'); o.value=String(h).padStart(2,'0'); o.textContent=String(h).padStart(2,'0'); hour.appendChild(o);
        }
      } else {
        for(let h=1; h<=12; h++){
          const o = document.createElement('option'); o.value=String(h).padStart(2,'0'); o.textContent=String(h); hour.appendChild(o);
        }
        ampm = document.createElement('select'); ['AM','PM'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; ampm.appendChild(o); });
        ampm.style.height='42px';
      }
      for(let m=0; m<60; m++){
        const o = document.createElement('option'); o.value=String(m).padStart(2,'0'); o.textContent=String(m).padStart(2,'0'); minute.appendChild(o);
      }

      // defaults / init
      if(init24){
        const [hh,mm] = init24.split(':');
        if(settings.timeFormat === '24'){ hour.value = hh; }
        else {
          const H = Number(hh); const isPM = H>=12; const h12 = ((H+11)%12)+1;
          hour.value = String(h12).padStart(2,'0'); ampm.value = isPM ? 'PM' : 'AM';
        }
        minute.value = mm;
      } else {
        const now = new Date(); let H = now.getHours(); const M = String(now.getMinutes()).padStart(2,'0');
        if(settings.timeFormat === '24'){ hour.value=String(H).padStart(2,'0'); }
        else { const isPM = H>=12; const h12 = ((H+11)%12)+1; hour.value = String(h12).padStart(2,'0'); ampm.value=isPM?'PM':'AM'; }
        minute.value=M;
      }

      wrap.appendChild(hour); wrap.appendChild(minute); if(ampm) wrap.appendChild(ampm);

      function to24(){
        const mm = minute.value;
        if(settings.timeFormat === '24'){
          return `${hour.value}:${mm}`;
        } else {
          let h = Number(hour.value);
          const isPM = ampm.value === 'PM';
          if(h === 12){ h = isPM ? 12 : 0 } else { if(isPM) h += 12 }
          return `${String(h).padStart(2,'0')}:${mm}`;
        }
      }
      return { wrap, to24 };
    }

    function openTaskModal(task){
      const isEdit = !!task;
      const nameVal = isEdit ? task.name : '';
      const startVal = isEdit ? task.start : null;
      const endVal = isEdit ? task.end : null;

      const startPicker = buildTimePicker(startVal);
      const endPicker = buildTimePicker(endVal);

      openModal(`
        <h3 style="margin:0 0 8px 0">${isEdit?'Edit Task':'Add Task'}</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="taskName" type="text" placeholder="Task name (e.g., Office work)" value="${nameVal.replace(/"/g,'&quot;')}" />
        </div>
        <div class="row" id="timePickers"></div>
        <div class="actions">
          <button class="btn" id="cancelBtn">Cancel</button>
          <button class="primary" id="saveBtn">${isEdit?'Save':'Add'}</button>
        </div>
      `);

      // mount pickers
      const tp = qs('#timePickers');
      const col1 = document.createElement('div'); const col2 = document.createElement('div');
      col1.innerHTML = `<label style="margin-bottom:6px">Start</label>`;
      col2.innerHTML = `<label style="margin-bottom:6px">End</label>`;
      col1.appendChild(startPicker.wrap);
      col2.appendChild(endPicker.wrap);
      tp.appendChild(col1); tp.appendChild(col2);

      qs('#cancelBtn').onclick = closeModal;
      qs('#saveBtn').onclick = ()=>{
        const nm = qs('#taskName').value.trim();
        const st = startPicker.to24();
        const ed = endPicker.to24();
        if(!nm) return alert('Please enter a task name');
        if(timeToMin(ed) <= timeToMin(st)) return alert('End time must be after start time');

        const r = currentRoutine();
        if(isEdit){ const t = r.tasks.find(x=>x.id===task.id); t.name=nm; t.start=st; t.end=ed; }
        else { r.tasks.push({ id: genId(), name: nm, start: st, end: ed }); }
        saveState(); closeModal(); renderAll();
      };
    }

    function deleteTask(id){
      if(!confirm('Delete this task?')) return;
      const r = currentRoutine();
      r.tasks = r.tasks.filter(t => t.id !== id);
      saveState(); renderAll();
    }

    // New routine modal
    newRoutineBtn.addEventListener('click', ()=>{
      openModal(`
        <h3 style="margin:0 0 8px 0">Create Routine</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="routineName" type="text" placeholder="Routine name (e.g., Weekends)" />
        </div>
        <div class="actions">
          <button class="btn" id="cancelR">Cancel</button>
          <button class="primary" id="saveR">Create</button>
        </div>
      `);
      qs('#cancelR').onclick = closeModal;
      qs('#saveR').onclick = ()=>{
        const name = qs('#routineName').value.trim();
        if(!name) return alert('Please name the routine');
        const r = { id: genId(), name, tasks: [] };
        state.routines.push(r); saveState();
        settings.selectedRoutineId = r.id; saveSettings();
        closeModal(); renderAll();
      };
    });

    /* =================== EVENTS =================== */
    // Add Task
    addTaskBtn.addEventListener('click', ()=> openTaskModal());

    // Routine select
    routineSelect.addEventListener('change', (e)=> {
      settings.selectedRoutineId = e.target.value;
      saveSettings(); renderAll();
    });

    // Drawer controls
    function openDrawer(){ drawer.classList.add('open'); drawerOverlay.classList.add('active'); drawer.setAttribute('aria-hidden','false') }
    function closeDrawer(){ drawer.classList.remove('open'); drawerOverlay.classList.remove('active'); drawer.setAttribute('aria-hidden','true') }
    menuBtn.addEventListener('click', openDrawer);
    closeDrawerBtn.addEventListener('click', closeDrawer);
    drawerOverlay.addEventListener('click', closeDrawer);

    // Settings
    timeFormatSelect.addEventListener('change', (e)=> { settings.timeFormat = e.target.value; saveSettings(); renderAll(); });
    themeSelect.addEventListener('change', (e)=> { settings.theme = e.target.value; saveSettings(); applyTheme(settings.theme); });

    // Keep "Now" updated every 30s
    setInterval(renderNow, 30000);

    // Initial render
    renderAll();

    // Optional PWA SW registration (uses your existing file if present)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./service-worker.js', { scope: './' }).catch(()=>{});
    }
  </script>
</body>
</html>
